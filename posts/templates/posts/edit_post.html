{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Edit Post</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #f2f4f8;
        padding: 40px 0;
        display: flex;
        justify-content: center;
      }
      .post-container {
        background: #ffffff;
        width: 600px;
        padding: 30px 40px;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      }
      .post-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }
      .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
      }
      .post-user-info {
        font-size: 16px;
        color: #333;
      }
      .post-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .input-box, select {
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 15px;
        width: 100%;
        box-sizing: border-box;
      }
      textarea.input-box {
        height: 100px;
        resize: vertical;
      }
      .upload-label {
        display: inline-block;
        background: #dfe6f3;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        color: #1f3f6e;
      }
      .file-upload input[type="file"] {
        display: none;
      }
      .preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .preview img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #ccc;
      }
      .update-btn,
      .cancel-btn {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        padding: 0 20px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        height: 42px;
        min-width: 100px;
        text-align: center;
        text-decoration: none;
        box-sizing: border-box;
      }
      .update-btn {
        background-color: #8cabb4;
        color: white;
      }
      .update-btn:hover {
        background-color: #6f95a3;
      }
      .cancel-btn {
        background-color: #d1d1d1;
        color: #000;
      }
      .cancel-btn:hover {
        background-color: #aaa;
      }
      .errorlist {
        color: red;
        font-size: 14px;
        margin: 5px 0;
        list-style: none;
        padding: 0;
      }
      .form-errors {
        background: #ffd2d2;
        color: #a33;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="post-container">
      <div class="post-header">
        {% if user.userprofile.avatar %}
          <img src="{{ user.userprofile.avatar.url }}" class="avatar">
        {% else %}
          <img src="{% static 'img/default_avatar.png' %}" class="avatar">
        {% endif %}
        <div class="post-user-info">
          <strong>{{ user.username }}</strong> &gt; <em>Edit your post</em>
        </div>
      </div>
  
      <div style="background: #fffbea; padding: 10px 14px; margin-bottom: 18px; border-left: 4px solid #f1c40f; border-radius: 8px; color: #333;">
        üì∏ ÁÖßÁâáËã•ÈúÄÂà™Èô§ÔºåË´ãÂÖàÂÑ≤Â≠òËçâÁ®øÂÜçÂà™Èô§„ÄÇË¨ùË¨ù
      </div> 
      <form method="POST" enctype="multipart/form-data" class="post-form">
        {% csrf_token %}
      
        <!-- Ê®ôÈ°å -->
        <input type="text" name="title" class="input-box" placeholder="Ê®ôÈ°å" value="{{ form.title.value|default_if_none:'' }}">
        {{ form.title.errors }}
      
        <!-- Ë≤ºÊñáÂÖßÂÆπ -->
        <textarea name="content" class="input-box" placeholder="ÂÖßÂÆπ">{{ form.content.value|default_if_none:'' }}</textarea>
        {{ form.content.errors }}
      
        <!-- Âú∞Èªû‰∏ãÊãâ -->
        <select name="location" class="input-box">
          <option value="">ÈÅ∏ÊìáÂú∞Èªû</option>
          {% for loc in locations %}
            <option value="{{ loc.id }}" {% if form.location.value|stringformat:"s" == loc.id|stringformat:"s" %}selected{% endif %}>{{ loc.name }}</option>
          {% endfor %}
        </select>
        {{ form.location.errors }}
      
        <!-- ÂàÜÈ°û‰∏ãÊãâ -->
        <select name="category" class="input-box">
          <option value="">ÈÅ∏ÊìáÂàÜÈ°û</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}" {% if form.category.value|stringformat:"s" == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>
        {{ form.category.errors }}
      
        <!-- Âú∞ÂùÄ -->
        <input type="text" name="address" class="input-box" placeholder="Âú∞ÂùÄ" value="{{ form.address.value|default_if_none:'' }}">
        {{ form.address.errors }}
      
        <!-- Â§öÂúñ‰∏äÂÇ≥ -->
        <div class="file-upload">
          <label class="upload-label" for="imageInput">+ Add Photo</label>
          <input id="imageInput" type="file" name="images" multiple accept="image/*">
        </div>
      
        <!-- Êñ∞‰∏äÂÇ≥È†êË¶Ω -->
        <div class="preview" id="previewBox"></div>
      
        <!-- Â∑≤ÊúâÂúñÁâá -->
        <div class="preview">
          {% for photo in post.photos.all %}
            <div class="photo-box" id="photo-{{ photo.id }}">
              <img src="{{ photo.image.url }}">
              <button type="button" class="delete-photo-btn" data-id="{{ photo.id }}">√ó</button>
            </div>
          {% endfor %}
        </div>
      
        <!-- Êèê‰∫§ -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit" class="update-btn">Êõ¥Êñ∞</button>
          <a href="{% url 'post_detail' post.pk %}" class="cancel-btn">ÂèñÊ∂à</a>
        </div>
      </form>
      
    </div>
  
    <script>
      document.getElementById("imageInput").addEventListener("change", function(event) {
        const preview = document.getElementById("previewBox");
        preview.innerHTML = "";
        const files = event.target.files;
        for (let i = 0; i < files.length; i++) {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(files[i]);
          preview.appendChild(img);
        }
      });
  
      // ÂúñÁâáÂà™Èô§
      document.querySelectorAll('.delete-photo-btn').forEach(button => {
        button.addEventListener('click', function () {
          const photoId = this.dataset.id;
          if (confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂºµÂúñÁâáÂóéÔºü")) {
            fetch(`/delete_photo/${photoId}/`, {
              method: 'POST',
              headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            }).then(response => {
              if (response.ok) {
                document.getElementById(`photo-${photoId}`).remove();
              } else {
                alert('Âà™Èô§Â§±Êïó');
              }
            });
          }
        });
      });
    </script>
  </body>
  </html>