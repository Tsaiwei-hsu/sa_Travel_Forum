{% extends 'posts/base.html' %}  {# 繼承 base 樣板 #}
{% load static %}                {# 載入 static 標籤 #}

{% block content %}
<style>
  /* 外框樣式 */
 .frame {
  position: relative;
  margin: 40px auto 30px auto;
  padding: 15px;
  width: 100%;
  max-width: 1300px; /* 加寬 */
  min-width: 400px;
  min-height: 600px;
  border: 1px solid #bbb;
  border-radius: 18px;
  background: #fff;
  box-sizing: border-box;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);

}

  html, body {
    height: 100%;
    overflow: auto !important; /* 只允許 body 滾動，不讓 .frame 滾動 */
  }

  @media (min-width: 1200px) {
    .frame {
      max-width: 1200px;
      min-width: 800px;
      height: 600px;
      aspect-ratio: 3/1;
      margin: 40px auto 30px auto;
    }
  }
  @media (max-width: 1000px) {
    .frame {
      max-width: 98vw;
      min-width: 0;
      width: 98vw;
      height: 420px;
      aspect-ratio: 2.5/1;
      padding: 3vw 1vw; /* 內距再縮小 */
    }
  }
  @media (max-width: 900px) {
    .frame {
      min-height: 320px;
      height: 320px;
      aspect-ratio: 2/1;
      max-width: 100vw;
      min-width: 0;
      padding: 8px;
      border-radius: 10px;
      margin: 20px 4px 20px 4px;
    }
    .main-content {
      height: auto;
      max-height: none;
      padding: 6px 0 0 0;
    }
    .post-preview-list {
      height: 100%;
      max-height: 100%;
    }
  }
  @media (max-width: 700px) {
    .frame {
      min-height: 180px;
      height: 180px;
      aspect-ratio: 1.5/1;
      width: 100vw;
      min-width: 0;
      max-width: 100vw;
      margin: 0;
      border-radius: 0;
      padding: 0;
    }
    .main-content {
      height: auto;
      max-height: none;
      padding: 2vw;
    }
    .post-preview-list {
      height: 100%;
      max-height: 100%;
    }
  }

  /* 主內容容器：左右分欄 */
  .container {
    flex: 1 1 0%;
    display: flex;
    min-height: 0;
    height: 100vh;
  }

  /* 側邊欄樣式 */
  .sidebar {
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* 桌機時不吸底 */
    width: 200px;
    padding: 10px;
    border-right: 1px solid #ccc;
    box-sizing: border-box;
    overflow: visible;
  }

  /* 側邊欄標題樣式 */
  .sidebar .category-title {
    font-weight: bold;
    margin-top: 10px;
  }

  /* 側邊欄連結樣式 */
  .sidebar .category-list a {
    display: block;
    padding: 3px 6px;
    margin: 2px 0;
    text-decoration: none;
    color: #333;
    border-radius: 4px;
  }

  /* 滑過側邊連結變色 */
  .sidebar .category-list a:hover {
    color: rgb(213, 168, 245);
  }

  /* 當前選取樣式 */
  .sidebar .category-list a.active {
    background-color: #ddd;
    font-weight: bold;
  }

  /* 主內容區塊樣式 */
  .main-content {
    display: flex;
    flex-direction: column;
    flex: 1 1 0%;
    min-width: 0;
    min-height: 0;
    height: 100%;
    box-sizing: border-box;
    overflow: hidden;
    padding: 10px 10px 10px 24px;
  }

  /* 貼文排列容器（縱向） */
  .post-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* 單張貼文卡片樣式 */
  .post-card {
    display: flex;
    align-items: center;
    border: 1px solid #ccc;
    border-radius: 12px;
    padding: 15px;
    background: #fff;
    gap: 20px;
  }

  /* 貼文圖片樣式 */
  .post-card img {
    width: 180px;
    height: 120px;
    object-fit: cover;
    border-radius: 10px;
    flex-shrink: 0;
  }

  /* 貼文文字區塊 */
  .post-card .text {
    flex: 1;
  }

  /* 浮動新增貼文按鈕 */
  .fab {
  position: absolute; /* 改為相對於 .frame */
  bottom: 20px;
  right: 20px;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #e7c2ec;
  color: #fff;
  font-size: 3rem;
  line-height: 80px;
  text-align: center;
  text-decoration: none;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
  transition: background 0.3s ease;
}

.post-card .text h4 a {
  color: #a26cc4;
  text-decoration: none;
}

.post-card .text h4 a:hover {
  color: #665a6c;
  text-decoration: underline;
}


  /* 浮動按鈕 hover 效果 */
  .fab:hover {
    background: #e7c2ec;
  }

  /* 內文貼文區捲動區塊 */
  .post-preview-list {
    flex: 1 1 0%;
    min-height: 0;
    overflow-y: auto;
    padding-right: 10px;
    box-sizing: border-box;
  }

  /* 側邊欄地點清單區塊（只針對地點） */
  .sidebar .location-list {
    max-height: 240px;
    overflow-y: auto;
    margin-bottom: 10px;
    transition: max-height 0.2s;
  }
  .sidebar .location-list.expanded {
    max-height: 400px;
    overflow-y: auto;
  }
  @media (max-width: 900px) {
    .sidebar .location-list {
      max-height: 120px;
    }
    .sidebar .location-list.expanded {
      max-height: 40vh;
      overflow-y: auto;
    }
  }
  @media (max-width: 700px) {
    .sidebar .location-list {
      max-height: 80px;
    }
    .sidebar .location-list.expanded {
      max-height: 50vh;
      overflow-y: auto;
    }
  }
  /* 側邊欄類型清單區塊（只針對景點類型） */
  .sidebar .category-section .category-list {
    max-height: 180px;
    overflow-y: auto;
  }

  .sidebar .category-list {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  .sidebar .category-list button {
    align-self: flex-start;
    margin-left: 0;
  }

  /* 類型選單區塊不再強制貼齊左下 */
  .sidebar .category-section {
    margin-top: 0;
  }

  /* 地點與景點類型之間的分隔線（置中於兩個區塊） */
  .sidebar .category-divider {
    width: 100%;
    height: 1px;
    background: #e0e0e0;
    margin-top: 24px;
    margin-bottom: 24px;
    border: none;
    position: relative;
    left: 0;
  }
  .sidebar .location-list {
    margin-bottom: 0;
  }
  /* 分隔線上下的標題間距恢復預設 */
  .sidebar .category-section .category-title {
    margin-top: 10px;
  }

  /* 框線底對齊「更多類型」按鈕，僅在小螢幕時吸底，桌機時正常流動 */
  .sidebar {
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* 桌機時不吸底 */
    width: 200px;
    padding: 10px;
    border-right: 1px solid #ccc;
    box-sizing: border-box;
    overflow: visible;
  }
  .category-section {
    display: block; /* 桌機時正常流動 */
    flex: none;
    margin-top: 0;
  }
  .category-list button#toggle-more-categories {
    margin-top: 12px;
    align-self: flex-start;
  }
  @media (max-width: 1000px) {
    .frame {
      width: 98vw;
      min-width: 0;
      padding: 5vw 2vw;
    }
    .sidebar {
      width: 140px;
      padding: 4px;
    }
    .main-content {
      padding: 4px;
    }
  }
  @media (max-width: 900px) {
    .frame {
      min-height: 60vh;
      max-width: 100vw;
      min-width: 0;
      padding: 8px;
      border-radius: 10px;
      margin: 20px 4px 20px 4px;
    }
    .main-content {
      height: auto;
      max-height: none;
      padding: 6px 0 0 0;
    }
    .post-preview-list {
      height: 100%;
      max-height: 100%;
    }
  }
  @media (max-width: 700px) {
    .frame {
      width: 100vw;
      min-width: 0;
      max-width: 100vw;
      min-height: 60vh;
      margin: 0;
      border-radius: 0;
      padding: 0;
    }
    .main-content {
      height: auto;
      max-height: none;
      padding: 2vw;
    }
    .post-preview-list {
      height: 100%;
      max-height: 100%;
    }
  }

  /* 讓「更多城市」按鈕樣式與「更多類型」一致 */
  .sidebar .location-list button#toggle-more {
    width: auto;
    min-width: 90px;
    margin-top: 12px;
    margin-bottom: 0;
    font-weight: normal;
    background: transparent;
    border: 1px solid #6c757d;
    color: #495057;
    border-radius: 4px;
    font-size: 0.95rem;
    padding: 2px 12px;
    box-shadow: none;
    transition: background 0.2s, color 0.2s, border 0.2s;
  }
  .sidebar .location-list button#toggle-more:hover {
    background: #f3f3f3;
    color: #007bff;
    border-color: #007bff;
  }
  .sidebar .location-list button#toggle-more:active,
  .sidebar .category-list button#toggle-more-categories:active {
    background: #e3eafc;
    color: #007bff;
    border-color: #007bff;
  }

  /* 讓側邊欄內容在小螢幕下可滑動，確保「更多城市」按鈕永遠可見 */
  @media (max-width: 900px) {
    .sidebar {
      overflow-y: auto;
      max-height: 60vh;
    }
  }
  @media (max-width: 700px) {
    .sidebar {
      overflow-y: auto;
      max-height: 60vh;
    }
  }
</style>

<!-- 主畫面結構 -->
<div class="frame">
  <div class="container">

    <!-- 側邊欄：城市與類型分類 -->
    <div class="sidebar">
      <!-- 城市選單 -->
      <div class="category-title">城市</div>
      <div class="category-list location-list">
        {% for location in locations %}
          {% if location.name in "Sydney Melbourne Brisbane Perth" %}
            <a href="{% url 'post_list' %}?location={{ location.name }}"
              class="{% if location.name == selected_location %}active{% endif %}">
              {{ location.name }}
            </a>
          {% endif %}
        {% endfor %}
        <!-- 更多城市 -->
        <div id="more-locations" style="display: none;">
          {% for location in locations %}
            {% if location.name not in "Sydney Melbourne Brisbane Perth" %}
              <a href="{% url 'post_list' %}?location={{ location.name }}"
                class="{% if location.name == selected_location %}active{% endif %}">
                {{ location.name }}
              </a>
            {% endif %}
          {% endfor %}
        </div>
        <!-- 城市展開按鈕 -->
        <button id="toggle-more" class="btn btn-sm btn-outline-secondary mt-2">更多城市 ▼</button>
      </div>
      <div class="category-divider"></div>
      <div class="category-section">
        <div class="category-title">景點類型</div>
        <div class="category-list" id="category-list">
          {% for category in categories|slice:":4" %}
            <a href="{% url 'filter_by_category' category.id %}{% if selected_location %}?location={{ selected_location }}{% endif %}"
               class="{% if current_category == category.name %}active{% endif %}">
              {{ category.name }}
            </a>
          {% endfor %}
          <div id="more-categories-1" style="display: none;">
            {% for category in categories|slice:"4:10" %}
              <a href="{% url 'filter_by_category' category.id %}{% if selected_location %}?location={{ selected_location }}{% endif %}"
                 class="{% if current_category == category.name %}active{% endif %}">
                {{ category.name }}
              </a>
            {% endfor %}
          </div>
          <div id="more-categories-2" style="display: none;">
            {% for category in categories|slice:"10:" %}
              <a href="{% url 'filter_by_category' category.id %}{% if selected_location %}?location={{ selected_location }}{% endif %}"
                 class="{% if current_category == category.name %}active{% endif %}">
                {{ category.name }}
              </a>
            {% endfor %}
          </div>
          <!-- 類型展開按鈕 -->
          <button id="toggle-more-categories" class="btn btn-sm btn-outline-secondary mt-2">更多類型 ▼</button>
        </div>
      </div>
    </div>

    <!-- 主內容：貼文列表 -->
    <div class="main-content">
      <!-- 成功訊息提示（置於主內容最上方） -->
      {% if messages %}
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
          <div style="max-width: 700px; width: 100%;">
            {% for message in messages %}
              <div class="alert alert-success" style="font-size: 1.1rem; border-radius: 10px; margin-bottom: 10px;">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
      <div class="header">
        <h2>所有貼文</h2>
      </div>
      <div class="post-preview-list">
        <div class="post-grid">
          {% for post in posts %}
          <div class="post-card">
            {% if post.photos.first %}
              <img src="{{ post.photos.first.image.url }}" alt="Post Photo">
            {% endif %}
            <div class="text">
              <h4><a href="{% url 'post_detail' post.pk %}">{{ post.title }}</a></h4>
              <p><strong>{{ post.author }}</strong> - {{ post.created_at|date:"Y年n月j日 H:i" }}</p>
              <p>{{ post.content|truncatechars:60 }}</p>
            </div>
          </div>        
          {% empty %}
            <p>目前尚無貼文。</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- 浮動新增貼文按鈕 -->
  <a href="{% url 'create_post' %}" class="fab">＋</a>
</div>

<!-- 展開城市／類型的 JS 控制 -->
<script>
  const toggleBtn = document.getElementById('toggle-more');
  const moreBlock = document.getElementById('more-locations');
  const locationList = document.querySelector('.location-list');
  let expanded = false;

  toggleBtn.addEventListener('click', () => {
    expanded = !expanded;
    moreBlock.style.display = expanded ? 'block' : 'none';
    toggleBtn.textContent = expanded ? '收起 ▲' : '更多城市 ▼';
    if (expanded) {
      locationList.classList.add('expanded');
    } else {
      locationList.classList.remove('expanded');
    }
  });

  const toggleCatBtn = document.getElementById('toggle-more-categories');
  const moreCatBlock1 = document.getElementById('more-categories-1');
  const moreCatBlock2 = document.getElementById('more-categories-2');
  let catExpandStep = 0; // 0:收合, 1:4→10, 2:10→全部

  toggleCatBtn.addEventListener('click', () => {
    catExpandStep = (catExpandStep + 1) % 3;
    if (catExpandStep === 1) {
      moreCatBlock1.style.display = 'block';
      moreCatBlock2.style.display = 'none';
      toggleCatBtn.textContent = '更多類型 ▼';
    } else if (catExpandStep === 2) {
      moreCatBlock1.style.display = 'block';
      moreCatBlock2.style.display = 'block';
      toggleCatBtn.textContent = '收起 ▲';
    } else {
      moreCatBlock1.style.display = 'none';
      moreCatBlock2.style.display = 'none';
      toggleCatBtn.textContent = '更多類型 ▼';
    }
  });
</script>
{% endblock %}